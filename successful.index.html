<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£›ç›¤æ¸¬é€Ÿï¼šéŒ„å½±èˆ‡åˆ†æ</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- App è¦–è¦ºé¢¨æ ¼ (ç²‰è‰²æ¼¸å±¤ä¸»é¡Œ) --- */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #c98098 0%, #ad498f 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .app-card {
            background-color: white;
            width: 100%;
            max-width: 600px;
            /* å¢åŠ å¯¬åº¦ä»¥å®¹ç´å½±ç‰‡é è¦½ */
            border-radius: 16px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.2);
            padding: 30px;
            text-align: center;
        }

        h1 {
            color: #d68da8;
            margin-bottom: 20px;
        }

        /* éŒ„å½±èˆ‡ä¸Šå‚³ Tab åˆ‡æ› */
        .tab-controls {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 700;
            color: #996c7d;
            border: none;
            background: transparent;
            transition: background-color 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #e08faa;
            border-bottom: 3px solid #be5e7e;
        }

        /* å½±ç‰‡é è¦½å€ */
        #videoPreview {
            width: 100%;
            max-height: 300px;
            background-color: #333;
            border-radius: 8px;
            display: none;
            /* é è¨­éš±è— */
            margin-bottom: 15px;
        }

        /* éŒ„å½±æ§åˆ¶æŒ‰éˆ• */
        .recorder-controls button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        /* éŒ„å½±æ¨¡å¼ */
        #startRecord {
            background-color: #7aa2d6;
            /* ç¶ è‰² */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
        }

        #stopRecord {
            background-color: #da5c53;
            /* ç´…è‰² */
            color: white;
            display: none;
        }

        /* æª”æ¡ˆä¸Šå‚³æ¨¡æ“¬å€å¡Š */
        .upload-section {
            border: 2px dashed #FFCDD2;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        /* é–‹å§‹åˆ†æä¸Šå‚³å½±ç‰‡ */
        .analysis-button {
            background-color: #7aa2d6;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            margin-top: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* çµæœé¡¯ç¤º */
        .result-display {
            padding: 20px;
            background-color: #FFF3E0;
            border-radius: 10px;
            margin-top: 30px;
        }

        #resultRPM {
            font-size: 4em;
            font-weight: 700;
            color: #e28264;
            margin: 10px 0;
        }
    </style>
</head>

<body>

    <div class="app-card">
        <h1>ğŸ¬ é£›ç›¤æ¸¬é€Ÿå„€</h1>

        <div class="tab-controls">
            <button class="tab-button active" onclick="showTab('record')">ç›´æ¥éŒ„å½±</button>
            <button class="tab-button" onclick="showTab('upload')">ä¸Šå‚³å½±ç‰‡</button>
        </div>

        <div id="recordTab" class="tab-content">
            <video id="videoPreview" autoplay playsinline muted></video>

            <div class="recorder-controls">
                <button id="startRecord" onclick="startRecording()">å•Ÿå‹•æ”å½±æ©Ÿ / é–‹å§‹éŒ„å½±</button>
                <button id="stopRecord" onclick="stopRecording()">åœæ­¢éŒ„å½±</button>
            </div>

            <button class="analysis-button" id="recordAnalysisButton" style="display: none;"
                onclick="startAnalysis()">åˆ†æéŒ„è£½å½±ç‰‡ (æ¨¡æ“¬)</button>
        </div>

        <div id="uploadTab" class="tab-content" style="display: none;">
            <div class="upload-section" onclick="document.getElementById('videoFile').click()">
                <input type="file" id="videoFile" accept="video/mp4" style="display: none;">
                <span id="uploadText">é»æ“Šæ­¤è™•é¸æ“‡å½±ç‰‡ (.mp4)</span>
            </div>
            <button class="analysis-button" onclick="startAnalysis()">é–‹å§‹åˆ†æä¸Šå‚³å½±ç‰‡</button>
        </div>

        <div class="result-display">
            <h2>åˆ†æçµæœ</h2>
            <div id="resultRPM">--- RPM</div>
            <div class="info-label">
                <span id="resultTime">æ™‚é–“: 0.00 ç§’</span> |
                <span id="resultRotations">åœˆæ•¸: 0.00 åœˆ</span>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        const videoPreview = document.getElementById('videoPreview');
        const startRecordButton = document.getElementById('startRecord');
        const stopRecordButton = document.getElementById('stopRecord');
        const recordAnalysisButton = document.getElementById('recordAnalysisButton');

        // --- é é¢ Tab åˆ‡æ›é‚è¼¯ ---
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId + 'Tab').style.display = 'block';
            document.querySelector(`.tab-controls button[onclick*="${tabId}"]`).classList.add('active');

            // åˆ‡æ›é é¢æ™‚ï¼Œåœæ­¢éŒ„å½±å’Œæ”å½±æ©Ÿ
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                videoPreview.style.display = 'none';
                startRecordButton.textContent = 'å•Ÿå‹•æ”å½±æ©Ÿ / é–‹å§‹éŒ„å½±';
                stopRecordButton.style.display = 'none';
            }
        }

        // --- éŒ„å½±åŠŸèƒ½ ---

        async function startRecording() {
            if (!stream) {
                // é¦–æ¬¡é»æ“Šï¼šå•Ÿå‹•æ”å½±æ©Ÿ
                try {
                    // è«‹æ±‚å­˜å–æ”å½±æ©Ÿå’Œéº¥å…‹é¢¨ï¼ˆé›–ç„¶åªç”¨æ”å½±æ©Ÿï¼‰
                    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                    videoPreview.srcObject = stream;
                    videoPreview.style.display = 'block';
                    startRecordButton.textContent = 'é–‹å§‹éŒ„å½±';

                } catch (err) {
                    console.error("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:", err);
                    alert("ç„¡æ³•å­˜å–æ”å½±æ©Ÿã€‚è«‹ç¢ºä¿æ‚¨ä½¿ç”¨ HTTPS æˆ– localhostï¼Œä¸¦æˆæ¬Šç€è¦½å™¨æ¬Šé™ã€‚");
                    return;
                }
            }

            // é–‹å§‹éŒ„å½±
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = () => {
                // éŒ„å½±åœæ­¢å¾Œï¼Œå°‡å½±ç‰‡ä¸‹è¼‰ä¸‹ä¾† (å› ç‚ºä¸èƒ½ç›´æ¥ä¸Šå‚³åˆ°æ¨¡æ“¬å¾Œç«¯)
                const blob = new Blob(recordedChunks, { type: 'video/mp4' });
                const url = URL.createObjectURL(blob);

                // é¡¯ç¤ºåˆ†ææŒ‰éˆ•
                recordAnalysisButton.style.display = 'block';
                recordAnalysisButton.onclick = () => {
                    // é€™è£¡æ‡‰è©²å°‡ blob ä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼Œä½†æˆ‘å€‘åœ¨å‰ç«¯æ¨¡æ“¬
                    startAnalysis(true, url); // true è¡¨ç¤ºä¾†è‡ªéŒ„å½±
                };

                // ç‚ºäº†è®“ä½¿ç”¨è€…çœ‹åˆ°éŒ„è£½çš„å…§å®¹
                videoPreview.srcObject = null;
                videoPreview.src = url;
                videoPreview.muted = false; // æ’­æ”¾æ™‚ä¸éœéŸ³
                videoPreview.controls = true; // é¡¯ç¤ºæ’­æ”¾æ§åˆ¶æ¢

                // åœæ­¢æ”å½±æ©Ÿè»Œé“ï¼Œé‡‹æ”¾è³‡æº
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                startRecordButton.textContent = 'å•Ÿå‹•æ”å½±æ©Ÿ / é–‹å§‹éŒ„å½±';
            };

            mediaRecorder.start();
            startRecordButton.style.display = 'none';
            stopRecordButton.style.display = 'block';
            recordAnalysisButton.style.display = 'none';

            console.log("é–‹å§‹éŒ„å½±...");
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                startRecordButton.style.display = 'block';
                stopRecordButton.style.display = 'none';
                console.log("åœæ­¢éŒ„å½±ã€‚");
            }
        }

        // --- å½±ç‰‡ä¸Šå‚³è™•ç† ---
        document.getElementById('videoFile').addEventListener('change', function (e) {
            const uploadText = document.getElementById('uploadText');
            if (e.target.files.length > 0) {
                uploadText.textContent = 'å·²é¸æ“‡æª”æ¡ˆ: ' + e.target.files[0].name;
                uploadText.style.color = '#00796B';

                // é¡¯ç¤ºä¸Šå‚³å½±ç‰‡é è¦½
                const fileURL = URL.createObjectURL(e.target.files[0]);
                videoPreview.src = fileURL;
                videoPreview.srcObject = null;
                videoPreview.controls = true;
                videoPreview.style.display = 'block';
                videoPreview.muted = true;

            } else {
                uploadText.textContent = 'é»æ“Šæ­¤è™•é¸æ“‡å½±ç‰‡ (.mp4)';
                uploadText.style.color = '#333';
                videoPreview.style.display = 'none';
            }
        });

        /**
         * æ¨¡æ“¬åˆ†æéç¨‹
         */
        function startAnalysis(fromRecording = false, videoUrl = null) {
            // æª¢æŸ¥æ˜¯å¦æœ‰å½±ç‰‡
            const uploadFile = document.getElementById('videoFile').files[0];
            if (!fromRecording && !uploadFile) {
                alert("è«‹å…ˆé¸æ“‡æˆ–éŒ„è£½ä¸€å€‹å½±ç‰‡æª”æ¡ˆï¼");
                return;
            }

            // é¡¯ç¤ºåˆ†æä¸­ç‹€æ…‹
            document.getElementById('resultRPM').textContent = "åˆ†æä¸­...";
            document.getElementById('resultRPM').style.color = '#777';

            // ä½¿ç”¨ setTimeout æ¨¡æ“¬å¾Œç«¯è™•ç†æ™‚é–“
            setTimeout(() => {
                // æ¨¡æ“¬åˆ†æçµæœ
                const simulatedRPM = Math.floor(Math.random() * (1200 - 600 + 1)) + 600;
                const simulatedTime = (Math.random() * (5 - 2) + 2).toFixed(2);
                const simulatedRotations = ((simulatedRPM / 60) * simulatedTime);

                // æ›´æ–°çµæœé¡¯ç¤º
                document.getElementById('resultRPM').textContent = simulatedRPM.toFixed(2) + " RPM";
                document.getElementById('resultRPM').style.color = '#FF5722';
                document.getElementById('resultTime').textContent = `æ™‚é–“: ${simulatedTime} ç§’`;
                document.getElementById('resultRotations').textContent = `åœˆæ•¸: ${simulatedRotations.toFixed(2)} åœˆ`;

                alert(`åˆ†æå®Œæˆï¼æ¸¬é€Ÿçµæœï¼š${simulatedRPM.toFixed(2)} RPM`);
            }, 3000); // æ¨¡æ“¬ 3 ç§’å»¶é²
        }

        // é è¨­è¼‰å…¥æ™‚é¡¯ç¤ºéŒ„å½±é é¢
        document.addEventListener('DOMContentLoaded', () => showTab('record'));
    </script>

</body>

</html>
